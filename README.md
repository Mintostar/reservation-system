# 予約サービス：設計書



### 1. サービス概要

個人経営者向けに、顧客がオンラインで予約を行える予約管理サービスを提供する。顧客は電話番号認証によりログインし、希望の日時・メニューを選んで予約でき、マイページから予約状況の確認やキャンセルが可能。

---

### 2. ユーザー種別

* 顧客（一般ユーザー）
* 管理者（施術者／店舗オーナー）

---

### 3. ユースケース

#### 顧客向け：

* ログイン（電話番号認証またはユーザー名／メールアドレス）
* 初回ログイン時に基本情報登録
* 初回登録時にメール配信設定の選択（プロモーション等の受信可否）
* 予約の作成（日時選択 → メニュー選択 → メモ入力 → 確認 → 予約確定）
* マイページで予約の確認／キャンセル（※キャンセル可能時間の制限あり）
* マイページからアカウント設定（メール配信設定含む）の変更

#### 管理者向け：

* ログイン
* 予約一覧の確認
* 顧客情報の閲覧
* メニュー・営業日・空き枠の管理
* 予約ステータスの変更（施術完了／無断キャンセルなど）
* 来院履歴の閲覧

---

### 4. 画面遷移図（顧客）

```text
[トップ画面]
 ├─> [ログイン（電話番号認証 or メール/ユーザー名＋パスワード）]
 │     └─> [初回情報入力（初回のみ）] ──┐
 │     └─> [アカウントをお持ちでない方はこちら（→ 新規登録）]
 │               └─> [電話番号認証 → ユーザー名／メール／パスワード登録 → メール配信設定（オン／オフ）]
 └─> [予約する]                              ↓
        ├─> [希望日時の選択（カレンダー）]
        ├─> [メニュー選択（一覧表示）]
        ├─> [メモ入力（自由記述）]
        ├─> [予約確認画面（確認・修正）]
        └─> [予約完了画面（通知あり）]

[マイページ]
 ├─> [予約一覧] ──> [詳細／キャンセル／ステータス表示（※キャンセルは予約開始◯時間前まで可能）]
 └─> [アカウント設定] ──> [メール配信設定の変更など]
```

---

### 5. データベース設計（Firestore）

#### collections:

* `users/{uid}`

  * name
  * phone
  * email
  * username
  * passwordHash
  * birthday
  * gender
  * createdAt
  * emailNotifications (boolean) ← メール配信設定

* `reservations/{reservationId}`

  * userId
  * date
  * time
  * menuId
  * memo
  * status: (confirmed / canceled / completed / no\_show)
  * createdAt
  * cancelDeadline ← キャンセル可能期限（予約日時から逆算）

* `menus/{menuId}`

  * title
  * description
  * price
  * durationMinutes ← メニューごとの所要時間
  * isActive

* `availability/{date}`

  * timeSlots: \["09:00", "09:30", "10:00", ...]
  * available: \[true, false, true, ...]

* `visitHistory/{userId}/{visitId}`

  * reservationId
  * date
  * time
  * menuTitle
  * notesFromAdmin

---

### 6. 認証・セキュリティ

* Firebase Authentication を使用

  * 初回新規登録画面で電話番号認証を行い、アカウント作成時にユーザー名またはメールアドレス＋パスワードも登録
  * 以後のログインは電話番号認証、またはメールアドレス／ユーザー名＋パスワードのいずれかで可能
* Firestore セキュリティルール：

  * 顧客は自身の予約データにのみアクセス可能
  * 管理者は全予約データ／顧客情報にアクセス可能

---

### 7. 主要機能仕様

#### 7.1 予約作成

* 空き枠（availability）から選択
* menuId に紐づくメニューを選択
* メニューに応じた durationMinutes に基づいて、必要な時間枠をまとめて確保（例：60分メニューで 09:00 開始 → 09:00～10:00 をブロック）
* 予約重複チェック
* Firestore に書き込み＋通知（メール／LINE）
* キャンセル可能期限を予約時に自動算出（例：施術開始24時間前まで）

#### 7.2 マイページ

* `reservations` を userId でフィルタして一覧表示
* キャンセルは予約の `cancelDeadline` を過ぎていない場合のみ可能（status → canceled）
* 過去の予約はステータス表示（完了／無断キャンセル）

#### 7.3 アカウント設定

* メール配信設定の確認／変更（on/off）

#### 7.4 管理機能（今後拡張）

* 空き時間の設定
* メニュー管理（追加／停止）
* 予約カレンダーの表示
* 来院履歴の確認
* 予約ステータスの管理（施術完了／無断キャンセル）

#### 7.5 予約カレンダーUI（顧客用）

* 月単位のカレンダーを表示
* 日付ごとに以下のステータスを表示：

  * ○（空きあり）
  * ×（満枠／予約不可）
  * 空きなしデータはグレーアウト表示
* ○の日付をクリックすると、モーダルが開いて当日の予約可能時間を一覧表示

  * 例：09:00／09:30／10:00... とボタンで表示
  * 空き枠はクリック可能、選択すると次のステップ（メニュー選択）に進む
* メニュー選択後、該当メニューの durationMinutes に応じて必要時間を自動確保（選択した時間から1時間枠など）
* 表示時間は Firestore の `availability/{date}` コレクションから取得


---

### 8. 通知

* 予約完了時：

  * LINE通知（LINE Messaging API）または メール（SendGrid等）
* リマインド通知：前日または当日朝
* メール配信設定がオン、かつメールアドレスが登録されている場合のみ、プロモーションやお知らせメールを配信
* 管理者向け通知：新規予約／キャンセル通知（メール or LINE）

---

### 9. 使用技術

* フロントエンド：Next.js（React）
* バックエンド／DB：Firebase（Authentication + Firestore）
* UIデザイン：Tailwind CSS
* 通知：LINE Messaging API, SendGrid（予定）

---

### 10. 今後の拡張案

* 管理画面での予約ブロック機能
* 定期予約機能
* クレジットカード事前決済
* 顧客の来店履歴・分析ダッシュボード
* ダッシュボードでの売上集計／予約分析
* 顧客タグ付け機能（リピーター／初回など）
